-----VYTVOŘENÍ TABULKY PRO CENY POHONNÝCH HMOT V EU -----

CREATE OR REPLACE TABLE EURO_PRICES AS
SELECT 
TO_DATE(WOTAX.DATE, 'DD/MM/YY')::DATE AS DATE, 
WOTAX.COUNTRY::VARCHAR(200) AS COUNTRY,
REPLACE (WOTAX.GASOLINE_1000L, ',', '')::FLOAT AS GASOLINE_WITHOUT_TAX,
REPLACE (WITHTAX.GASOLINE_1000L, ',', '')::FLOAT AS GASOLINE_WITH_TAX,
GASOLINE_WITH_TAX - GASOLINE_WITHOUT_TAX AS GASOLINE_TAX_DELTA,
ROUND (GASOLINE_TAX_DELTA/GASOLINE_WITH_TAX*100,2)AS GASOLINE_DELTA_PERCENT,
REPLACE (WOTAX.DIESEL_1000L, ',', '')::FLOAT AS DIESEL_WITHOUT_TAX,
REPLACE (WITHTAX.DIESEL_1000L, ',', '')::FLOAT AS DIESEL_WITH_TAX,
DIESEL_WITH_TAX - DIESEL_WITHOUT_TAX AS DIESEL_TAX_DELTA,
ROUND (DIESEL_TAX_DELTA/DIESEL_WITH_TAX*100,2) AS DIESEL_DELTA_PERCENT
FROM "KEBOOLA_3424"."WORKSPACE_409334099"."euro-oil-bulletin-price-wo-tax-consumer-prices-wo-taxes" AS WOTAX
LEFT JOIN "KEBOOLA_3424"."WORKSPACE_409334099"."euro-oil-bulletin-price-with-tax-list1" AS WITHTAX
ON WOTAX.DATE = WITHTAX.DATE AND WOTAX.COUNTRY = WITHTAX.COUNTRY
;


----ROZŠÍŘENÍ TABULKY EURO_PRICES O TEMPA RŮSTU-----
CREATE OR REPLACE TABLE EURO_PRICES_INCL_GROWTH AS
SELECT
DATE,
COUNTRY,
GASOLINE_WITHOUT_TAX,
GASOLINE_WITH_TAX,
GASOLINE_WITH_TAX - LAG (GASOLINE_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC) AS PRICE_GROWTH_GASOLINE,
ROUND((GASOLINE_WITH_TAX - LAG (GASOLINE_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC))/LAG (GASOLINE_WITH_TAX) 
      OVER (PARTITION BY COUNTRY ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_GASOLINE,
GASOLINE_TAX_DELTA,
GASOLINE_DELTA_PERCENT,
DIESEL_WITHOUT_TAX,
DIESEL_WITH_TAX,
DIESEL_WITH_TAX - LAG (DIESEL_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC) AS PRICE_GROWTH_DIESEL,
ROUND((DIESEL_WITH_TAX - LAG (DIESEL_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC))/LAG (DIESEL_WITH_TAX) 
      OVER (PARTITION BY COUNTRY ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_DIESEL,
DIESEL_TAX_DELTA,
DIESEL_DELTA_PERCENT
FROM EURO_PRICES
;

----TABULKA PRUMER EU VČETNĚ TEMPA RŮSTU
---A/ PRO GASOLINE
CREATE OR REPLACE TABLE AVERAGE_GASOLINE_PRICES_EU AS 
SELECT 
DATE, 
ROUND(AVG(GASOLINE_WITH_TAX),2) AS AVERAGE_GASOLINE_WITH_TAX_EU,
AVERAGE_GASOLINE_WITH_TAX_EU - LAG (AVERAGE_GASOLINE_WITH_TAX_EU) OVER (ORDER BY DATE ASC) AS PRICE_GROWTH_GASOLINE_EU,
ROUND((AVERAGE_GASOLINE_WITH_TAX_EU - LAG (AVERAGE_GASOLINE_WITH_TAX_EU) OVER (ORDER BY DATE ASC))/LAG (AVERAGE_GASOLINE_WITH_TAX_EU) OVER (ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_GASOLINE_EU
FROM EURO_PRICES
GROUP BY DATE
;

---B/PRO DIESEL
CREATE OR REPLACE TABLE AVERAGE_DIESEL_PRICES_EU AS 
SELECT 
DATE, 
ROUND(AVG(DIESEL_WITH_TAX),2) AS AVERAGE_DIESEL_WITH_TAX_EU,
AVERAGE_DIESEL_WITH_TAX_EU - LAG (AVERAGE_DIESEL_WITH_TAX_EU) OVER (ORDER BY DATE ASC) AS PRICE_GROWTH_DIESEL_EU,
ROUND((AVERAGE_DIESEL_WITH_TAX_EU - LAG (AVERAGE_DIESEL_WITH_TAX_EU) OVER (ORDER BY DATE ASC))/LAG (AVERAGE_DIESEL_WITH_TAX_EU) OVER (ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_DIESEL_EU
FROM EURO_PRICES
GROUP BY DATE
;


----DOPLNĚNÍ SLOUPCE - TEMPO RŮSTU ---ZKOUŠKA VÝPOČTU

----A/U PRUMERNE CENY ZA CELOU EU
SELECT  DATE,
        AVERAGE_GASOLINE_WITH_TAX_EU,
        AVERAGE_GASOLINE_WITH_TAX_EU - LAG (AVERAGE_GASOLINE_WITH_TAX_EU) OVER (ORDER BY DATE ASC) AS PRICE_GROWTH_GASOLINE_EU,
       ROUND((AVERAGE_GASOLINE_WITH_TAX_EU - LAG (AVERAGE_GASOLINE_WITH_TAX_EU) OVER (ORDER BY DATE ASC))/LAG (AVERAGE_GASOLINE_WITH_TAX_EU) OVER (ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_GASOLINE_EU
FROM AVERAGE_GASOLINE_PRICES_EU
;

SELECT  DATE,
        AVERAGE_DIESEL_WITH_TAX_EU,
        AVERAGE_DIESEL_WITH_TAX_EU - LAG (AVERAGE_DIESEL_WITH_TAX_EU) OVER (ORDER BY DATE ASC) AS PRICE_GROWTH_DIESEL_EU,
       ROUND((AVERAGE_DIESEL_WITH_TAX_EU - LAG (AVERAGE_DIESEL_WITH_TAX_EU) OVER (ORDER BY DATE ASC))/LAG (AVERAGE_DIESEL_WITH_TAX_EU) OVER (ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_DIESEL_EU
FROM AVERAGE_DIESEL_PRICES_EU
;
----B/PODLE JEDNOTLIVÝCH ZEMÍ

SELECT 
DATE,
COUNTRY,
GASOLINE_WITH_TAX, 
GASOLINE_WITH_TAX - LAG (GASOLINE_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC) AS PRICE_GROWTH_GASOLINE,
ROUND((GASOLINE_WITH_TAX - LAG (GASOLINE_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC))/LAG (GASOLINE_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_GASOLINE
FROM EURO_PRICES
LIMIT 1000
;

SELECT 
DATE,
COUNTRY,
DIESEL_WITH_TAX, 
DIESEL_WITH_TAX - LAG (DIESEL_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC) AS PRICE_GROWTH_DIESEL,
ROUND((DIESEL_WITH_TAX - LAG (DIESEL_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC))/LAG (DIESEL_WITH_TAX) OVER (PARTITION BY COUNTRY ORDER BY DATE ASC)*100, 3) AS PRICE_PERCENTAGE_GROWTH_DIESEL
FROM EURO_PRICES
LIMIT 1000
;

SELECT DATE,
MAX(PRICE_GROWTH_GASOLINE_EU) AS MAXIMUM
FROM "AVERAGE_GASOLINE_PRICES_EU"
GROUP BY DATE
ORDER BY MAXIMUM DESC;
